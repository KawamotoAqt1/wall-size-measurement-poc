@startuml 表札おすすめ原寸合成フロー
title 表札おすすめと原寸合成フロー シーケンス図

actor ユーザ as U
participant ブラウザ as B
participant サーバー as S
participant "ChatGPT" as G

== フェーズ1: 門柱撮影と基準オブジェクト検出 ==

U -> B: カメラ起動・門柱全体を撮影
B -> S: 門柱写真をアップロード
S -> S: 基準オブジェクト検出\n(ポスト/ドアホン/ブロック等)
S --> B: 基準オブジェクト座標JSON\n{x, y, w, h}を返却
B -> U: 写真上に検出枠を描画し\n位置確認を依頼
U --> B: 枠位置の確認(OK / 修正)

alt 位置修正あり
  B -> U: ドラッグなどで枠を調整
  U --> B: 調整後の枠位置を確定
  B -> B: 修正後座標を採用
end

B -> B: 基準オブジェクトの規格寸法と\n画素数から門柱幅を概算\n(+/-5cm程度の誤差を許容)

== フェーズ2: 表札取付範囲の指定と切り出し ==

B -> U: 表札取付範囲を\n写真上で四角形選択するよう促す
U -> B: 門柱写真上で取付範囲をドラッグ選択
B -> B: 選択範囲を切り出し\n「取付範囲画像」を生成
B -> B: 門柱幅から取付範囲の実幅を算出

== フェーズ3: 家全体写真撮影とChatGPT解析 ==

B -> U: 家全体の写真撮影を依頼
U -> B: 家全体写真を撮影
B -> S: 門柱写真・家全体写真・取付範囲画像を送信
S -> G: 3枚の画像とプロンプトを送信\n(家の雰囲気と合う表札テイストの分析依頼)
G --> S: 雰囲気説明テキストと\nおすすめ表札の特徴タグを返却
S -> S: テキスト・タグを整形
S --> B: 雰囲気説明テキストと\n推奨タグ(色/素材/スタイル/書体など)

== フェーズ4: ブラウザ内商品DBから候補抽出と一覧生成 ==

B -> B: ローカル商品DBに対して検索・フィルタ
note right of B
検索条件:
- サーバーから受け取った推奨タグ
  (色, 素材, スタイル, 書体 など)
- 取付範囲の「実幅」に収まる\n表札サイズ条件
end note

B -> B: 「おすすめ商品リスト」をブラウザ内で作成

loop おすすめ商品ごと
  B -> S: 商品画像取得リクエスト\n(商品ID)
  S --> B: 商品画像(表札テンプレート)返却
  B -> B: ユーザ指定の名前文字列を\n商品画像に合成
  B -> U: 合成済み商品画像を\n一覧に追加表示
end

== フェーズ5: 選択商品を門柱写真に原寸で合成(ブラウザ完結) ==

U -> B: 一覧から好みの商品を1つ選択
B -> B: 取付範囲の実寸と門柱写真の\nスケールから商品の実寸をピクセル換算
B -> B: 門柱写真上の取付範囲枠内に\n選択商品を原寸比率で画像合成
B -> U: 門柱写真と表札を合成した\nプレビュー画像を表示

@enduml
