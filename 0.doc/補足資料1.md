以下に、**「これまで作った基本設計書や処理フロー資料に追加する補足資料」**として、
今回のチャット内容をわかりやすくまとめた文書を作成します。

Markdown形式で、既存資料の末尾にそのまま追記できる構成にしています。

---

# 📄 補足資料：基準物検出方式（YOLO）および全体フローの再整理

**AIお勧め表札提案システム（実寸計測付）補足資料**
作成日：2025-11-19

---

## 1. 追加仕様：基準物検出はサーバー側 YOLO モデルで実行

本システムにおける**基準物（ポスト・ドアホン・ブロック等）の検出**は、
**ブラウザ側ではなくサーバー側で YOLO モデルを用いて実施する**。

### ● 検出対象クラス

* **ポスト（postbox）**
* **インターホン（intercom）**
* **コンクリートブロック（block）**
  （JIS 規格サイズのためスケール計算に利用可能）

### ● サーバーでの処理内容

1. ブラウザからアップロードされた門柱画像を受け取る
2. サーバー側で YOLO 推論を実行
3. 最も適切な基準物（confidence 最大）を選択
4. 次の情報を JSON でブラウザへ返す：

```json
{
  "reference_object": {
    "type": "postbox",
    "x": 120,
    "y": 300,
    "width": 200,
    "height": 150,
    "confidence": 0.94
  },
  "pillar_image_width": 1080,
  "pillar_image_height": 1920
}
```

### ● ブラウザ側の役割

* YOLO が返した座標で画像上に枠（バウンディングボックス）を描画
* ユーザーに「枠が合っているか」を確認させる
* 規格品の実寸（例：ポスト幅 34cm 等）から門柱幅を概算する
  → **寸法変換はブラウザ側で実施**

---

## 2. 尺度換算の考え方（重要）

YOLO が返すのは **ピクセル幅・高さ**。
基準物は規格サイズを持つため、以下の式で概算スケールを求める：

```
1mm あたりのピクセル数 = 基準物検出幅(px) ÷ 基準物の実寸幅(mm)
門柱の概算幅(mm) = 門柱画像のピクセル幅 × (実寸換算係数)
```

※ 誤差 ±5cm 程度は許容する想定（目的は表札合成の視覚的実寸再現）

---

## 3. 全体フローの補強説明（要点）

これまでの設計で定義したフローを、YOLO 追加前提で整理すると以下になる：

### ① 門柱画像 → 基準物検出（YOLO）

* ブラウザで撮影した門柱画像をサーバーに送信
* サーバー側 YOLO で物体検出
* 検出された基準物の枠情報がブラウザへ返る
* ブラウザで枠を表示し、ユーザーが「OK」と確認
* ブラウザ側で規格サイズに基づき門柱の概算寸法を計算

### ② 取付範囲のユーザー指定

* Canvas 上でドラッグして範囲選択
* ピクセル幅を記録
* 同範囲の切り抜き画像を生成（後で ChatGPT に渡す）

### ③ 家全体の写真 → ChatGPT による雰囲気分析

* ブラウザ → サーバーへ以下の画像を送信：

  * 門柱写真
  * 取付範囲の切り抜き画像
  * おうち全体の写真
* サーバーがそれらを ChatGPT（GPT-4 mini）へ送信
* 「家の雰囲気の説明文」「表札のおすすめ特徴」「タグ一覧」を受領

### ④ ブラウザ内商品DBから候補抽出

* サーバーから受け取ったタグを元に
  **ローカル商品DB（JSON）をフィルタリング**
* さらに取付範囲の寸法（ピクセル→mm換算）でサイズ条件に一致する商品のみ抽出
* ユーザー名＋商品画像を Canvas で合成しサンプル一覧を表示

### ⑤ 選択した商品を門柱写真へ実寸合成

* 商品の実寸（mm）とスケール係数を元に
  門柱写真に「実寸に近い比率」で配置
* 最終合成結果を表示・保存可能

---

## 4. 追加設計ポイント

### ● サーバー側に YOLO 推論環境を構築

* Python + PyTorch / Ultralytics（YOLOv8）を想定
* さくらVPS内で GPU がない場合でも軽量モデルで対応可

### ● 基準物の規格サイズ辞書をブラウザ側に保持

例：

```json
{
  "postbox": { "width_mm": 340, "height_mm": 150 },
  "intercom": { "width_mm": 90, "height_mm": 140 },
  "block": { "width_mm": 390, "height_mm": 190 }
}
```

### ● 誤検出時の補正

* 枠がズレている場合はユーザーに手動調整 UI を提供する（後日実装）

---

## 5. 補足まとめ

* **基準物検出はサーバー側 YOLO で行う**ことが仕様として確定
* ブラウザ側は YOLO の検出結果を受け取り
  **寸法換算と表示を担当**
* ChatGPT は雰囲気分析と商品タグ抽出に特化
* 商品候補選出はすべてブラウザ側でローカル処理
* 最終的な「原寸に近い合成」もブラウザ内 Canvas で完結

---

