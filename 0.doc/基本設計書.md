# AIお勧め表札提案システム（実寸計測付）基本設計書

## 1. 文書情報

* 文書名：AIお勧め表札提案システム 基本設計書
* バージョン：v0.1（たたき台）
* 作成日：2025-11-19
* 作成者：XXX
* 対象読者：

  * プロジェクトオーナー
  * フロントエンド開発担当（HTML/JS/CSS）
  * サーバーサイド開発担当
  * インフラ担当（さくらVPS）

---

## 2. システム概要

### 2.1 システム名称

* **AIお勧め表札提案-実寸計測付**

### 2.2 目的

* ユーザーがスマホやPCブラウザから門柱の写真と自宅の写真を撮影・アップロードすることで、

  * 門柱の概算寸法を自動推定し
  * 自宅の雰囲気に合った表札候補を AI が提案し
  * ユーザー名入りの表札を一覧表示し
  * 最終的に**実寸に近い比率で門柱写真に合成したイメージ**を確認できるようにする。

### 2.3 利用シナリオ（ざっくり）

1. ユーザーが門柱を撮影 → 規格品（ポスト等）から**門柱サイズ概算**。
2. ユーザーが「表札取り付け範囲」をブラウザ上で指定。
3. ユーザーが自宅全体を撮影 → ChatGPT が家の雰囲気を分析し、**おすすめ表札の特徴（タグ）**を返す。
4. ブラウザ内の商品DBからタグ＋取付範囲サイズでフィルタ → **おすすめ商品リスト表示**。
5. ユーザーが商品を選択 → Canvas で**実寸スケール合成**して完成イメージを表示。

---

## 3. システム構成・技術要件

### 3.1 クライアント（ブラウザ側）

* 技術構成

  * HTML5
  * JavaScript（フレームワーク：未定／要検討）
  * CSS（デザインフレームワーク：未定／要検討）
  * **Canvas API**：画像表示・バウンディングボックス描画・表札合成
  * Web API（fetch / XMLHttpRequest）でサーバーと通信
  * カメラアクセス（スマホ時）：`getUserMedia` / `<input type="file" accept="image/*" capture="camera">` など

* 主な責務

  * 画像の撮影／アップロード UI
  * Canvas 上での画像表示・枠描画・ドラッグ操作
  * サーバーAPIとの通信（画像送信・結果受領）
  * ローカル商品DB（JSON）の読み込み・フィルタリング
  * 選択商品画像＋ユーザー名を使った合成表示
  * 完成イメージの保存・ダウンロード（任意）

### 3.2 サーバー側（さくらのVPS）

* インフラ

  * さくらのVPS
  * OS：Linux 系（CentOS / Ubuntu など）※要決定
  * Webサーバー：Nginx or Apache ※要決定
  * アプリケーション：Node.js / Python / PHP 等 ※要決定

* 主な責務

  * 画像アップロード受付・保存（テンポラリ）
  * 門柱画像からの基準オブジェクト検出（ポスト等）
    → 座標 (`x, y, w, h`) の算出
  * ChatGPT API との連携

    * 門柱画像・おうち画像・取り付け位置画像を入力
    * 雰囲気分析結果＋おすすめ表札の特徴テキストを取得
  * ブラウザ向けレスポンス生成

    * 基準オブジェクトの枠情報
    * 門柱幅の概算値（mm）
    * ユーザー向け説明文
    * 商品タグ情報（検索用タグ配列）

* 保持データ

  * 必須ではないが、ログとしてリクエスト内容・タグ結果・合成履歴などを保存可能（後述）

### 3.3 AI（ChatGPT API）

#### 利用モデル

* **GPT-4 mini**（OpenAI API）

  * 画像入力に対応
  * 高速・低コストで、今回の用途（雰囲気分析・タグ抽出）に十分な性能
  * 推論速度が速いため、ユーザー体験向上にも寄与

#### 主な役割

* 門柱写真・取付範囲画像・おうち全体の写真を入力として解析し、
  以下を返す：

  * 家の雰囲気の説明文
  * 表札に適した特徴（色、素材、フォント、テイスト）
  * 商品DBに紐づけるための **タグ候補一覧**

#### モデル選定理由

* GPT-4 mini は画像理解精度が十分高く、
  今回の **デザイン傾向の抽出・タグ化** といったタスクとの相性が良い。
* GPT-4 Turbo ほど高コストではなく、運用負荷が低い。
* スマホ環境でもレスポンスを維持しやすい。

---

## 4. 機能一覧（概要）

| No | 機能カテゴリ | 機能名           | 概要                                |
| -- | ------ | ------------- | --------------------------------- |
| 1  | 画像取得   | 門柱画像撮影・アップロード | ブラウザから門柱の画像を取得                    |
| 2  | 画像解析   | 基準オブジェクト検出    | サーバーでポスト等を検出し門柱幅の概算に利用            |
| 3  | 画像表示   | 門柱画像＋枠表示      | Canvas 上に門柱画像と検出枠を描画しユーザーに確認させる   |
| 4  | 入力操作   | 取り付け範囲指定      | ユーザーがドラッグで表札取り付け範囲を指定             |
| 5  | 画像取得   | おうち全体写真撮影     | 自宅全体の写真を撮影／アップロード                 |
| 6  | AI解析   | 雰囲気・おすすめ特徴抽出  | ChatGPT に画像を渡し、説明文と商品タグの元になる特徴を取得 |
| 7  | 商品検索   | ブラウザ内DB検索     | タグと寸法条件で候補表札を検索・絞り込み              |
| 8  | 画像合成   | 名前入り表札サンプル生成  | 商品画像＋ユーザー名を合成したサンプル画像を生成          |
| 9  | 一覧表示   | おすすめ商品リスト表示   | 候補表札をリスト表示し、選択可能にする               |
| 10 | 画像合成   | 門柱への実寸合成      | 選択商品を原寸比率で門柱画像の取付範囲に合成            |
| 11 | 出力     | 完成イメージ表示・保存   | 完成イメージの表示、および保存／DL 機能（任意）         |
| 12 | 共通     | エラーハンドリング     | 通信エラー・画像解析エラー時のメッセージ表示            |

---

## 5. 画面設計（概要）

※ここでは画面の「役割」と主な UI 要素のみを定義します。詳しいワイヤーフレームは別紙。

### 5.1 トップ画面（モード選択）

* 機能：

  * 「おうちにピッタリ（3つの質問）」など、既存UIの一部として本機能への入口ボタンを配置
  * 本システムは「AI表札提案（実寸）」モードとして起動

### 5.2 門柱撮影・確認画面

* 要素：

  * 門柱画像撮影／アップロードボタン
  * Canvas 埋め込みエリア（門柱画像表示）
  * 「画像をサーバーに送信」ボタン
  * サーバーから返却された基準オブジェクト枠の表示
  * 「枠は正しいですか？」確認 UI（OK / NG）
* 処理：

  * OK → 門柱幅概算を内部状態（JavaScript）に保持
  * NG → 再撮影 or 手動修正（※手動修正は後続検討）

### 5.3 取付範囲指定画面

* 要素：

  * 門柱画像（Canvas 再利用）
  * ドラッグで矩形選択できる UI
  * 「この範囲に表札を付ける」ボタン
* 処理：

  * 選択矩形を画像として切り出し（Canvas → Blob）
  * 取付範囲のピクセル幅・高さを記録（後でスケール計算に使用）

### 5.4 おうち全体撮影画面

* 要素：

  * 自宅全体画像の撮影／アップロード
  * 「AI に分析させる」ボタン
* 処理：

  * 門柱画像＋取付範囲切り抜き＋おうち全体画像をサーバーへ送信

### 5.5 おすすめ結果表示・商品選択画面

* 要素：

  * AI からの説明文（家の雰囲気、表札の方向性）
  * おすすめ商品リスト（スクロールエリア）

    * 各カードに：名前入りサンプル画像、商品名、サイズ情報、タグなど
  * ユーザー名入力欄（例：「山田」）
* 処理：

  * ユーザー名変更時に、Canvas等で商品画像に名前を合成（ローカル処理）
  * 各商品カードに「これを門柱に合成」ボタン

### 5.6 合成結果表示画面

* 要素：

  * 合成後の門柱画像（Canvas）
  * 拡大・縮小・パン操作（任意）
  * 「画像を保存」ボタン（Blob → DL）
* 処理：

  * Canvas 上で実寸比率を考慮した表札画像のスケーリング＆描画

---

## 6. アーキテクチャ概要

### 6.1 全体構成

* クライアント：ブラウザ（HTML/JS/CSS + Canvas）
* サーバー：さくらVPS 上の Web アプリケーション
* 外部サービス：OpenAI ChatGPT API

通信はすべて HTTPS を前提とする。

### 6.2 コンポーネント

* フロントエンド

  * UI コンポーネント群
  * 画像処理モジュール（Canvasラッパ）
  * 商品DB検索モジュール
  * API クライアント（サーバー呼び出し）

* サーバー

  * 画像アップロード／管理モジュール
  * 画像解析モジュール（基準オブジェクト検出）
  * ChatGPT クライアントモジュール
  * レスポンス生成モジュール（JSON）

---

## 7. 処理フロー概要（時系列）

※ 詳細はシーケンス図（別途 `.wsd`）にて定義予定。

1. **門柱画像アップロード**
   ブラウザ → サーバー：門柱画像送信
   サーバー：基準オブジェクト検出 → 枠情報 JSON 返却

2. **ユーザー確認 → 門柱幅概算算出**
   ブラウザ：枠表示、ユーザー OK →
   規格サイズテーブルを元に門柱幅概算値（mm）を算出して保持

3. **取付範囲指定**
   ブラウザ：Canvas 上で矩形選択 → 切り抜き画像＋ピクセル幅を保持

4. **おうち全体写真＋画像群をサーバーへ**
   ブラウザ → サーバー：門柱画像、取付範囲画像、おうち全体画像送信
   サーバー → ChatGPT：上記画像情報を投げて雰囲気分析依頼

5. **AI から特徴テキスト・タグ取得**
   ChatGPT → サーバー：おすすめ表札の特徴テキスト（説明文）＋タグ候補
   サーバー：タグの正規化やマッピングを行い、ブラウザへ返却

6. **ブラウザ内商品DBフィルタ**
   ブラウザ：タグ＋取付範囲寸法でローカル商品DBを検索
   → おすすめ商品リスト生成

7. **名前入り表札サンプル生成**
   ブラウザ：商品ごとに

   * 商品基本画像（サーバーから取得）
   * ユーザー名テキスト
     を合成して Canvas でレンダリング → サムネイル生成

8. **商品選択 → 門柱画像へ実寸合成**
   ブラウザ：

   * 門柱幅概算（mm）と画像ピクセル幅からスケール係数算出
   * 表札の実寸サイズ（商品DBに定義）を使い、Canvas 上で適切なピクセルサイズに変換
   * 取付範囲の矩形座標内に収まるよう位置調整・描画

---

## 8. API 設計（概要）

※ エンドポイント名・詳細仕様は詳細設計で確定。

### 8.1 ブラウザ → サーバー API

1. **門柱画像解析 API**

   * メソッド：`POST /api/v1/pillar/analyze`
   * 入力：

     * 門柱画像（multipart/form-data）
   * 出力（JSON）例：

     ```json
     {
       "reference_object": {
         "type": "postbox",
         "x": 120,
         "y": 300,
         "width": 200,
         "height": 150
       },
       "pillar_image_width": 1080,
       "pillar_image_height": 1920
     }
     ```

2. **雰囲気分析 API**

   * メソッド：`POST /api/v1/house/analyze`
   * 入力：

     * 門柱画像
     * 取付範囲画像
     * おうち全体画像
   * 出力（JSON）例：

     ```json
     {
       "description": "モダンで落ち着いた印象のおうちです。... ",
       "tags": ["モダン", "黒ベース", "ステンレス", "横長", "シンプル"]
     }
     ```

3. **商品画像取得 API**

   * メソッド：`GET /api/v1/products/{product_id}/image`
   * 出力：商品画像（PNG/JPEG）

### 8.2 サーバー → ChatGPT API

* **使用モデル：`gpt-4o-mini`（GPT-4 miniの最新 API 名称）**
* 入力：

  * 画像（base64 もしくは URL）
  * プロンプト：

    ```
    これらの画像（門柱、取り付け位置、自宅全体）を元に、
    家の雰囲気と表札に適した特徴を日本語で説明してください。
    また、表札商品検索に使うタグ候補もできるだけ具体的に返してください。
    出力フォーマット：
    { 
      "description": "...",
      "tags": ["...", "...", ...]
    }
    ```
* 出力（例）：

  ```json
  {
    "description": "黒と白のコントラストが強いモダンスタイルの外観です。表札はステンレスや黒系がマッチします。",
    "tags": ["モダン", "ステンレス", "黒ベース", "直線的", "シンプル"]
  }
  ```
---

# 🔍 運用における注意点（GPT-4 mini）

* モデル切替が必要になった場合に備え、
  **API 呼び出し部分はモデル名を環境変数として設定**する設計とする。
  例：`OPENAI_MODEL=gpt-4o-mini`
* プロンプトはシステムプロンプト＋ユーザープロンプトの2段構成で安定化
* GPT-4 mini の画像認識精度は高いが、色や質感の解釈でぶれが出る可能性がある
  → タグ正規化ロジックはサーバー側で補正（例：「黒」「ブラック」「black」→`黒ベース`）

---

---

## 9. データ設計（概要）

### 9.1 ブラウザ内商品DB（JSON想定）

例：

```json
{
  "products": [
    {
      "id": "P001",
      "name": "モダンブラックステンレス横長",
      "width_mm": 300,
      "height_mm": 80,
      "tags": ["モダン", "黒ベース", "ステンレス", "横長"],
      "image_path": "/assets/products/P001.png"
    }
  ]
}
```

* 配置場所：ブラウザから取得可能な静的 JSON として配信（同一オリジン想定）
* 検索条件：

  * タグ一致（AND/OR は要検討）
  * 取付範囲の寸法（幅に収まる商品など）

---

## 10. 非機能要件（概要）

### 10.1 パフォーマンス

* スマホ回線（4G）でも実用的なレスポンス
* 画像アップロードサイズ：1枚あたり上限 5MB 程度（要調整）
* サムネイル生成はブラウザ側で行い、サーバー負荷を抑制

### 10.2 セキュリティ

* 全通信 HTTPS
* 画像は必要な期間のみ保存し、一定期間で削除（プライバシー配慮）
* OpenAI API キーはサーバー側でのみ保持し、ブラウザに露出させない

### 10.3 ログ・監視

* サーバーログ：

  * リクエスト種別・時間・エラー情報
* 必要に応じて

  * AI 推奨タグの統計（人気のテイスト傾向など）

---

## 11. 今後の詳細設計項目

* フロントエンド詳細：

  * 使用フレームワーク（Vanilla JS / React / Vue など）
  * Canvas 操作ライブラリ導入有無
* サーバー言語・フレームワーク選定
* OpenAI モデル選定（gpt-4.x, o3-mini など）
* 基準オブジェクト検出の具体実装

  * 自前モデル or 外部 Vision API 利用 など
* シーケンス図（PlantUML `.wsd`）の詳細化と整合確認

---
