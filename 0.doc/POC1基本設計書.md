以下に **基本設計書（POC版）** を Markdown 形式で作成します。
今回のゴールである **「寸法測定ができ、貼り付け位置のW/H実寸が表示できるところまで」** を完全にカバーした基本設計書です。

必要であれば、この内容を既存の基本設計書 v0.2 に統合する形式でも作成できます。

---

# **AIお勧め表札 POC 基本設計書（寸法測定版） v0.1**

## 1. 文書目的

本ドキュメントは、AIお勧め表札システムの **寸法測定機能に特化したPOC（Proof of Concept）** を実装するための基本設計書である。

本POCでは、画像内の基準物（ポスト、ドアホン、ブロック）を検出し、
ユーザーによる目視確認・実寸補正を行ったうえで、
画像上に描画した任意範囲（四角枠）の **実寸幅・高さ（mm）** を算出・表示することを目的とする。

※商品検索・合成処理などは本POCには含まない。

---

# 2. 対象範囲（スコープ）

## 2.1 本POCで実施する内容

1. **画像アップロード/撮影**
2. サーバーへの画像送信
3. サーバー側での **YOLO による基準物検出**
4. ブラウザでの基準物バウンディングボックス表示
5. **ユーザーによる基準物枠の目視確認**
6. 基準物の実寸サイズの初期値表示 & **ユーザーが入力して修正可能**
7. ユーザーの確定値をもとに **スケール(px/mm)を確定**
8. ユーザーが画像上でドラッグして **貼り付け位置（矩形）を指定**
9. **矩形の実寸 W(mm) / H(mm) の表示**

---

## 2.2 本POCで実施しない内容（除外）

* AIタグ生成（雰囲気推定）
* 商品DB検索・おすすめリスト生成
* 表札デザイン生成（Midjourney等）
* 門柱への表札合成
* UIデザイン（高精度）
  → 本POCではワイヤーフレームレベルで十分
* ログイン機構
* 履歴保存

---

# 3. システム構成

## 3.1 利用技術

| 区分    | 技術                                   |
| ----- | ------------------------------------ |
| ブラウザ  | HTML, CSS, JavaScript / Canvas API   |
| AI連携  | ChatGPT API（※本POCでは使用しない想定）          |
| サーバー  | さくらVPS（Linux）, Python（FastAPI想定）     |
| AIモデル | YOLO（学習済モデル）                         |
| 画像処理  | Python + OpenCV                      |
| 通信方式  | REST API（JSON + multipart/form-data） |

---

# 4. 処理フロー（POC版）

```
[ユーザー]  
  ↓ 画像選択  
[ブラウザ]  
  ↓ 画像送信 (POST /pillar/analyze)  
[サーバー YOLO推論]  
  ↓ 基準物の bbox + 種別 + confidence を返却  
[ブラウザ]  
  ↓ 基準物枠の表示  
↓ ユーザー確認  
  ├─ OK → 実寸入力へ  
  └─ NG → 手動で枠を引き直し  
ユーザーが実寸を確定  
↓  
スケール(px/mm)確定  
↓  
貼り付け位置ドラッグ  
↓  
四角枠の実寸 W(mm), H(mm) を計算して表示
```

---

# 5. 画面仕様（ブラウザ）

## 5.1 画面構成（ワイヤーフレームテキスト）

```
--------------------------------------------------
① 画像選択エリア
 [ファイルを選択]  [カメラで撮影]

② 解析ボタン
 [基準物を解析する]

③ Canvasエリア
 +-------------------------------------------+
 |  門柱画像                                 |
 |   ┌──────────────┐ 基準物枠(緑)         |
 |   └──────────────┘                     |
 +-------------------------------------------+

④ 基準物の確認
 「この枠は正しいですか？」
    [はい]  [いいえ（枠を修正）]

⑤ 基準物実寸の編集
 基準物：ポスト
 - 幅(mm)：[ 340 ]
 - 高さ(mm)：[ 150 ]
 [基準寸法を確定]

⑥ 貼り付け位置の指定
 「画像の上で四角をドラッグしてください」

（Canvas上にユーザーが作成した枠を表示）

⑦ サイズ表示
 貼り付け位置のサイズ（実寸）
 - 幅： xxx mm
 - 高さ： yyy mm
 - アスペクト比： W:H
--------------------------------------------------
```

---

# 6. API仕様（POC版）

## 6.1 基準物解析API

### エンドポイント

```
POST /api/v1/pillar/analyze
```

### リクエスト

* Content-Type: `multipart/form-data`
* フィールド：

  * `pillar_image`: 画像ファイル

### レスポンス例（成功）

```json
{
  "reference_object": {
    "type": "postbox",
    "x": 120,
    "y": 300,
    "width": 200,
    "height": 150,
    "confidence": 0.94
  },
  "pillar_image_width": 1080,
  "pillar_image_height": 1920
}
```

### レスポンス（基準物なし）

```json
{
  "reference_object": null,
  "pillar_image_width": 1080,
  "pillar_image_height": 1920
}
```

### エラー形式

```json
{
  "error": {
    "code": "yolo_inference_failed",
    "message": "object detection failed"
  }
}
```

---

# 7. 基準寸法・スケール計算仕様

## 7.1 スケール計算式

ユーザーが確定した基準物実寸を以下とする：

```
ref_width_mm
```

YOLOが検出した枠の幅（px）：

```
bbox_width_px
```

### px → mm の変換係数

```
mm_per_px = ref_width_mm / bbox_width_px
```

（または px_per_mm を利用しても良い）

---

# 8. 貼り付け位置の矩形寸法計算

ユーザーのドラッグ開始・終了座標：

```
(x1, y1), (x2, y2)
```

矩形サイズ(px):

```
rect_width_px  = |x2 - x1|
rect_height_px = |y2 - y1|
```

実寸(mm):

```
rect_width_mm  = rect_width_px  * mm_per_px
rect_height_mm = rect_height_px * mm_per_px
```

アスペクト比：

```
ratio = rect_width_mm : rect_height_mm
```

---

# 9. 画面遷移（ステート管理）

| ステート | 説明          |
| ---- | ----------- |
| S0   | 画像未選択       |
| S1   | 解析中         |
| S2   | 基準物枠のユーザー確認 |
| S3   | 基準物実寸入力・確定  |
| S4   | 貼り付け位置指定モード |
| S5   | 矩形寸法表示      |

---

# 10. テスト観点（POC）

## 10.1 正常系

* ポスト・ドアホン・ブロックが明確に写っている写真で正しく検出
* ユーザーの入力値から正しいスケール計算が行われる
* 貼り付け位置の矩形が正しい実寸値を示す

## 10.2 準正常

* 明暗差の大きい画像
* 基準物が端に寄っている
* ドアホンのみ写っている

## 10.3 異常系

* 基準物が検出できない
  → 「基準物が見つかりません」表示
* 不正な入力値（例：負の値）
  → バリデーション

---

# 11. 今後の発展（本開発時の利用想定）

本POCの成果は、以下のフェーズで直接活用可能：

* 正確な門柱寸法推定
* 商品マッチング条件（最大幅・高さでフィルタ）
* 原寸合成（Canvas上でのScale変換に利用）

---

必要があれば、この基本設計書（POC版）を **正式な基本設計書 v0.2 に統合した「v0.3」** としてまとめ直しますのでお知らせください。
